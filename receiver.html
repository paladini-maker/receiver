<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Custom Receiver — Shaka</title>

  <!-- Shaka -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.15.12/shaka-player.compiled.js"></script>

  <!-- Cast Receiver SDK (no ?loadCastFramework) -->
  <script src="https://www.gstatic.com/cast/sdk/libs/receiver/2.0.0/cast_receiver_framework.js"></script>

  <style>
    html,body { height:100%; margin:0; background:#000; display:flex; align-items:center; justify-content:center; }
    video { width:100%; height:100%; max-width:1280px; max-height:720px; background:black; }
    #status { position: fixed; left:8px; top:8px; color:#ccc; font-size:12px; }
  </style>
</head>
<body>
  <div id="status">Receiver arrancando...</div>
  <video id="video" autoplay playsinline></video>

  <script>
    const status = (t) => { console.log(t); document.getElementById('status').textContent = t; };

    // Inicializa Cast Receiver Context
    const context = cast.framework.CastReceiverContext.getInstance();

    // Opciones: podés forzar useShakaForHls u otras opciones aquí
    const options = new cast.framework.CastReceiverOptions();
    // opcional: options.disableIdleTimeout = true;
    // Podés fijar una versión de Shaka si lo necesitás:
    // options.disableIdleTimeout = true;
    context.start(options);
    status('CastReceiver context started.');

    // Inicia Shaka con el video del receiver
    const video = document.getElementById('video');
    shaka.polyfill.installAll();
    const shakaPlayer = new shaka.Player(video);
    window.shakaReceiverPlayer = shakaPlayer;

    shakaPlayer.addEventListener('error', e => {
      console.error('ShakaReceiver error', e);
      status('Shaka Error: ' + (e.detail ? JSON.stringify(e.detail) : e));
    });

    // El PlayerManager maneja mensajes LOAD del sender.
    const manager = context.getPlayerManager();

    // Interceptamos el LOAD para usar Shaka en vez del player por defecto
    manager.setMessageInterceptor(cast.framework.messages.MessageType.LOAD, (request) => {
      try {
        const media = request.media || {};
        const contentId = media.contentId || (media && media.metadata && media.metadata.secondaryMediaUrl);
        status('LOAD request interceptada. contentId=' + contentId);

        if (!contentId) {
          console.warn('No contentId en LOAD request, permitiendo manejo por defecto.');
          return request;
        }

        // Usamos Shaka para cargar el contentId
        // Si necesitás ClearKey, configurá shakaPlayer.configure({'drm':{ 'clearKeys': {...}}});
        (async () => {
          try {
            // Si querés manejar la metadata o las keys, hacelo antes de load
            await shakaPlayer.load(contentId);
            status('Shaka: media cargada OK.');
            // Informamos al manager que el LOAD se procesó (devuelve null para que el playerManager no haga el load por defecto)
            // Nota: devolvemos null para bloquear el manejo por defecto (ya lo cargamos con Shaka).
          } catch (err) {
            console.error('Error cargando con Shaka en receiver:', err);
            status('Shaka load error: ' + err);
          }
        })();

        // Devuelve null para evitar que el Cast default trate de reproducir (hemos tomado control).
        return null;
      } catch (ex) {
        console.error('Interceptor LOAD exception', ex);
        return request; // deja que lo maneje por defecto en caso de error
      }
    });

    status('Receiver listo. Esperando LOAD desde sender...');
  </script>
</body>
  </html>
